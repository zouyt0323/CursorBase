# Camera App 高级功能参考

## 1. 滤镜系统设计

### 1.1 滤镜分类

| 分类 | 示例滤镜 | 实现方式 | 性能影响 |
|------|---------|---------|---------|
| **基础色彩** | 暖色、冷色、黑白、复古、胶片 | Color Matrix / LUT | 低 |
| **风格化** | 油画、素描、水彩、漫画 | OpenGL Shader | 中 |
| **光效** | 光晕、镜头光斑、散景模拟 | GPU Fragment Shader | 中 |
| **纹理叠加** | 胶片颗粒、漏光、边框 | Texture Blend | 低 |
| **AI 风格迁移** | 梵高、莫奈、浮世绘 | ML Model (TFLite) | 高 |

### 1.2 滤镜技术架构

```
┌─────────────────────────────────────────┐
│              滤镜管理器                    │
│  FilterManager                          │
├─────────────────────────────────────────┤
│                                         │
│  ┌──────────┐  ┌──────────┐  ┌────────┐│
│  │ LUT 滤镜  │  │ Shader   │  │ ML 滤镜││
│  │ Filter   │  │ Filter   │  │ Filter ││
│  └────┬─────┘  └────┬─────┘  └───┬────┘│
│       │              │             │     │
│       ▼              ▼             ▼     │
│  ┌──────────────────────────────────┐   │
│  │     OpenGL ES 渲染管线            │   │
│  │  (GLSurfaceView / TextureView)   │   │
│  └──────────────────────────────────┘   │
│                    │                     │
│                    ▼                     │
│  ┌──────────────────────────────────┐   │
│  │     CameraX Preview Surface      │   │
│  └──────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

### 1.3 LUT (Look-Up Table) 滤镜

**原理**：将颜色映射表存储为 512x512 PNG 图片，GPU 采样实现实时色彩转换。

**式样要点**：
- LUT 图片格式：64x64x64 3D LUT → 展开为 512x512 PNG
- 滤镜预览列表：水平滚动 RecyclerView / LazyRow
- 预览缩略图：64x64 dp，实时应用 LUT
- 滤镜强度滑杆：0%-100%，默认 100%
- 自定义滤镜：支持导入外部 LUT 文件

### 1.4 滤镜式样模板

```
#### F-XXX: [滤镜名称]

| 属性 | 值 |
|------|------|
| 分类 | 基础色彩 / 风格化 / 光效 / 纹理 / AI |
| 实现方式 | LUT / Shader / ML Model |
| 实时预览 | 是 / 否 |
| 强度可调 | 是 / 否 |
| 预估 GPU 耗时 | < Xms/帧 |
| 内存占用 | < XMB |
| 最低设备要求 | OpenGL ES 3.0+ / GPU Compute |
```

---

## 2. 美颜系统设计

### 2.1 美颜功能分级

| 级别 | 功能 | 实现方式 | 复杂度 |
|------|------|---------|:------:|
| **L1 基础** | 磨皮、美白 | 双边滤波 + 亮度调整 | 低 |
| **L2 进阶** | 瘦脸、大眼、小脸 | 人脸关键点 + 网格变形 | 中 |
| **L3 高级** | 眉毛/嘴唇/腮红/眼影 | 人脸分割 + 局部着色 | 高 |
| **L4 AI** | 风格妆容、虚拟试妆 | GAN / 扩散模型 | 很高 |

### 2.2 美颜技术链路

```
Camera 帧 → 人脸检测 → 关键点定位 → 美颜处理 → 渲染输出
               │            │              │
               ▼            ▼              ▼
          ML Kit Face   468 点 Mesh    GPU Shader
          Detection     Landmarks      Pipeline
```

### 2.3 人脸检测方案对比

| 方案 | 精度 | 速度 | 大小 | 推荐场景 |
|------|:----:|:----:|:----:|---------|
| **ML Kit Face Detection** | 高 | 快 | 内置 | 基础美颜（推荐） |
| **MediaPipe Face Mesh** | 很高 | 快 | ~5MB | 高级美颜（468点） |
| **OpenCV + dlib** | 中 | 中 | ~50MB | 自定义需求 |
| **自训练 TFLite 模型** | 可控 | 可控 | 可控 | 特殊需求 |

### 2.4 美颜参数式样模板

```
#### 美颜参数：[参数名称]

| 属性 | 值 |
|------|------|
| 参数范围 | 0-100 |
| 默认值 | XX |
| 实时预览 | 是 |
| 依赖 | 人脸检测 / 关键点定位 / 分割 |
| GPU Shader | [shader 名称] |
| 处理耗时 | < Xms/帧 |
```

### 2.5 美颜参数完整列表

| 参数 | 范围 | 默认值 | 技术 | 级别 |
|------|------|:------:|------|:----:|
| 磨皮强度 | 0-100 | 50 | 双边滤波 | L1 |
| 美白程度 | 0-100 | 30 | 亮度/饱和度调整 | L1 |
| 红润度 | 0-100 | 20 | 红色通道增强 | L1 |
| 锐化程度 | 0-100 | 30 | Unsharp Mask | L1 |
| 瘦脸程度 | 0-100 | 0 | 网格变形 | L2 |
| 大眼程度 | 0-100 | 0 | 局部放大 | L2 |
| 小脸程度 | 0-100 | 0 | 网格收缩 | L2 |
| 下巴调整 | 0-100 | 0 | 关键点移动 | L2 |
| 额头调整 | 0-100 | 50 | 关键点移动 | L2 |
| 鼻翼缩小 | 0-100 | 0 | 局部收缩 | L2 |
| 嘴唇厚度 | 0-100 | 50 | 关键点移动 | L2 |
| 口红颜色 | 色值 | 无 | 唇部分割+着色 | L3 |
| 腮红颜色 | 色值 | 无 | 区域着色 | L3 |
| 眼影颜色 | 色值 | 无 | 眼部分割+着色 | L3 |

---

## 3. AI 场景检测

### 3.1 场景分类

| 场景 ID | 场景名称 | 优化策略 | 识别准确率目标 |
|---------|---------|---------|:------------:|
| S01 | 人像 | 背景虚化、肤色优化 | > 95% |
| S02 | 风景 | 饱和度提升、天空增强 | > 90% |
| S03 | 美食 | 暖色调、饱和度提升 | > 85% |
| S04 | 夜景 | 降噪增强、HDR 合成 | > 90% |
| S05 | 文档 | 锐化、对比度增强、裁剪 | > 90% |
| S06 | 二维码 | 自动对焦、快速识别 | > 95% |
| S07 | 宠物 | 眼部对焦、连拍 | > 85% |
| S08 | 花草 | 微距模式、色彩增强 | > 80% |
| S09 | 运动 | 快速快门、连拍 | > 80% |
| S10 | 雪景 | 曝光补偿、白平衡调整 | > 80% |

### 3.2 AI 场景检测架构

```
Camera Preview Frame (YUV)
         │
         ▼
  ┌──────────────┐
  │  帧采样器     │  (每 N 帧检测一次，节省算力)
  │  (1/5 帧)    │
  └──────┬───────┘
         │
         ▼
  ┌──────────────┐
  │  图像预处理   │  (缩放到 224x224, 归一化)
  └──────┬───────┘
         │
         ▼
  ┌──────────────┐
  │  场景分类模型  │  (TFLite / MobileNet V3)
  │  ~3MB        │
  └──────┬───────┘
         │
         ▼
  ┌──────────────┐
  │  结果平滑器   │  (连续 3 帧相同结果才切换)
  └──────┬───────┘
         │
         ▼
  ┌──────────────┐
  │  参数优化器   │  (根据场景调整拍摄参数)
  └──────────────┘
```

### 3.3 模型选型

| 模型 | 大小 | 推理速度 | 精度 | 推荐 |
|------|------|---------|:----:|:----:|
| MobileNet V3 Small | ~2MB | ~5ms | 85% | 低端设备 |
| MobileNet V3 Large | ~5MB | ~10ms | 92% | 推荐 |
| EfficientNet-Lite0 | ~5MB | ~12ms | 93% | 高端设备 |
| 自训练模型 | 可控 | 可控 | 可控 | 特殊需求 |

---

## 4. HDR 与多帧合成

### 4.1 HDR 模式

```
短曝光帧 ─┐
中曝光帧 ──┼──→ 对齐 → 合成 → 色调映射 → HDR 图片
长曝光帧 ─┘
```

| HDR 方案 | 实现难度 | 效果 | 推荐 |
|----------|:-------:|:----:|:----:|
| CameraX HDR Extension | 低 | 中 | 快速实现 |
| Camera2 多帧捕获 + 手动合成 | 高 | 高 | 最佳效果 |
| 第三方 SDK (如 GPUImage) | 中 | 中高 | 折中方案 |

### 4.2 夜景模式

```
多帧长曝光（6-16帧）
         │
         ▼
    帧对齐（光流法）
         │
         ▼
    降噪合成（多帧平均 + AI 降噪）
         │
         ▼
    色调映射 + 细节增强
         │
         ▼
    最终输出
```

---

## 5. 视频录制高级功能

### 5.1 录制参数式样

| 参数 | 选项 | 默认值 |
|------|------|:------:|
| 分辨率 | 720p / 1080p / 4K | 1080p |
| 帧率 | 24 / 30 / 60 fps | 30fps |
| 编码 | H.264 / H.265 (HEVC) | H.264 |
| 比特率 | 自动 / 手动 (8-50 Mbps) | 自动 |
| 音频编码 | AAC | AAC |
| 音频采样率 | 44.1kHz / 48kHz | 48kHz |
| 防抖 | EIS / OIS / 关闭 | EIS |
| 最大时长 | 无限 / 15s / 30s / 60s / 自定义 | 无限 |

### 5.2 视频特效

| 特效 | 实现方式 | 实时预览 |
|------|---------|:--------:|
| 变速 (0.5x-2x) | MediaCodec 重编码 | 是 |
| 实时滤镜 | OpenGL Shader | 是 |
| 美颜 | GPU + 人脸检测 | 是 |
| 背景虚化 | 深度传感器 / AI 分割 | 条件 |
| 贴纸/特效 | AR 叠加 | 是 |
